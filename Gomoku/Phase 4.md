# 多人五子棋（Goku）项目 - 第五阶段开发文档：智能化与创新实践

## 1. 阶段目标

**核心目标**: 将**人工智能 (AI)**、**数据驱动决策**和**高级架构模式**深度融入系统，创造卓越的用户体验和极致的运营效率。此阶段的重点是将项目从一个功能完备的服务，转变为一个能够自我优化、智能响应并引领技术趋势的平台。

**技术焦点**:
- **高级AI机器人**: 引入基于机器学习（如蒙特卡洛树搜索 - MCTS）的高级AI，提供更具挑战性和拟人化的对手。
- **智能化运维 (AIOps)**: 建立智能告警和根因分析系统，从被动响应问题转变为主动预测和预防问题。
- **数据驱动优化**: 构建数据分析管道，通过分析用户行为来优化游戏平衡性、用户留存和功能设计。
- **事件驱动架构 (EDA)**: 探索将部分核心业务（如比赛撮合、排行榜更新）改造为异步的事件驱动模式，提升系统解耦和弹性。
- **全球化部署与低延迟**: 探索多区域部署方案，为全球玩家提供低延迟的游戏体验。

---

## 2. 范围与边界

### ✅ **本阶段包含 (In-Scope)**:

- **机器学习AI机器人**:
    - 开发或集成一个使用MCTS或类似算法的五子棋AI引擎。
    - 将此AI引擎封装为一个独立的微服务 (`advanced-bot-service`)。
    - 允许用户在创建房间时选择不同难度的机器人（简单、中等、困难/AI）。
- **智能化告警与分析**:
    - 在监控系统中（如Datadog, New Relic或Azure Monitor）配置复合告警规则和异常检测（Anomaly Detection）。
    - 建立一个集中的Grafana仪表盘，关联业务指标（如DAU、房间创建率）和系统指标（延迟、错误率），用于快速定位问题。
- **用户行为分析管道**:
    - 将游戏事件（如落子、胜负、时长）发送到数据仓库（如Azure Synapse Analytics, Google BigQuery）。
    - 使用BI工具（如Power BI, Tableau）创建仪表盘，分析玩家胜率、常用开局、流失节点等。
- **异步撮合系统 (Event-Driven)**:
    - 引入消息队列（如RabbitMQ, Azure Service Bus）。
    - 创建一个新的“快速匹配”功能：玩家点击匹配后，请求被发送到消息队列，由一个独立的撮合服务（Matcher Service）异步处理并创建房间。
- **多区域部署探索 (可选，作为概念验证)**:
    - 将应用部署到两个不同地理位置的云区域（如美国东部和西欧）。
    - 使用Cloudflare等全球网络服务进行流量路由，将玩家连接到最近的服务器。
    - 探索使用托管数据库的读副本（Read Replicas）来降低跨区域的数据读取延迟。

### ❌ **本阶段不包含 (Out-of-Scope)**:

- **全面重构为事件溯源 (Event Sourcing)**: 仅在特定场景尝试事件驱动，不对整个系统进行架构颠覆。
- **实时机器学习模型训练**: AI模型的训练是离线进行的。
- **多云架构**: 所有部署仍在单一云厂商（如Azure）内进行。
- **服务网格的高级应用**: 如多集群联邦等。
- **自愈系统**: 暂不实现基于AIOps的自动修复或回滚。

---

## 3. 任务分解与技术实现

### 3.1. 智能AI与游戏体验任务

#### **任务 1: 开发高级AI机器人服务**

- **技术栈**:
    - **AI引擎**: 可以选择使用Python生态中的成熟库（如`alpha-zero-gomoku`的实现），或者用C#实现MCTS算法。
    - **服务封装**: 使用gRPC或HTTP将AI引擎封装为一个微服务。gRPC因其高性能更适合此场景。
- **集成逻辑**:
    1.  房间服务在需要AI落子时，不再调用内部的简单AI逻辑。
    2.  而是向`advanced-bot-service`发送一个gRPC请求，请求中包含当前棋盘状态和AI难度等级。
    3.  高级AI服务接收请求，运行算法计算出最佳落子点，并通过gRPC响应返回。
- **`bot.proto` (gRPC定义示例)**:
    ```protobuf
    syntax = "proto3";
    
    package bot;
    
    service AdvancedBot {
      rpc GetNextMove (BoardStateRequest) returns (MoveResponse);
    }
    
    message BoardStateRequest {
      repeated int32 board = 1; // 扁平化的一维数组表示棋盘
      int32 difficulty = 2; // 0=easy, 1=medium, 2=hard
    }
    
    message MoveResponse {
      int32 x = 1;
      int32 y = 2;
    }
    ```

### 3.2. 智能化运维 (AIOps) 任务

#### **任务 1: 配置智能告警**

- **平台**: Azure Monitor, Datadog, New Relic等。
- **操作**:
    - **异常检测**: 启用平台提供的基于机器学习的异常检测功能，监控关键指标（如P95延迟、服务器错误率）。当指标偏离历史正常模式时，即使未达到固定阈值，也会触发告警。
    - **复合告警**: 创建关联多个指标的告警规则。例如：**仅当“CPU使用率 > 80%” AND “P95延迟 > 500ms”同时发生超过5分钟**时，才触发一个高优先级告警。这可以有效减少告警疲劳。

#### **任务 2: 建立统一业务健康仪表盘**

- **平台**: Grafana
- **操作**:
    1.  **多数据源集成**: 将Prometheus（系统指标）、PostgreSQL（业务数据）、Application Insights（APM数据）等多个数据源添加到Grafana。
    2.  **创建仪表盘**:
        - **顶层KPI**: 显示核心业务指标，如每日活跃用户（DAU）、平均游戏时长、付费转化率（如果未来有）。
        - **服务健康概览**: 显示每个微服务的请求率、错误率和延迟（RED指标）。
        - **资源利用率**: 显示数据库连接数、CPU/内存使用率等。
        - **关联性**: 使用Grafana的变量功能，可以根据选择的业务事件（如“新用户注册高峰”）来联动显示所有相关的系统指标变化，帮助快速进行根因分析。

### 3.3. 数据驱动与架构演进任务

#### **任务 1: 构建用户行为分析管道**

- **架构**:
    `Room Service` -> `Azure Event Hubs` -> `Azure Stream Analytics` -> `Azure Synapse Analytics / Power BI`
- **操作**:
    1.  **数据发送**: 房间服务在游戏结束时，将一条包含对局信息的JSON消息（如玩家ID、胜负、时长、棋谱）异步发送到Azure Event Hubs。
    2.  **数据处理**: 创建一个Azure Stream Analytics作业，它从Event Hubs读取数据，进行简单的清洗和转换。
    3.  **数据存储与可视化**: 将Stream Analytics的输出连接到Azure Synapse Analytics（用于长期存储和复杂查询）或直接连接到Power BI（用于实时仪表盘）。
    4.  **分析**: 在Power BI中创建报告，分析如“哪个先手开局胜率最高？”、“玩家在连续输掉几局后最容易流失？”等问题。

#### **任务 2: 实现异步快速匹配系统**

- **架构**:
    `API Gateway` -> `POST /matchmaking` -> `Room Service` -> `RabbitMQ (Message Queue)` -> `Matcher Service`
- **操作**:
    1.  **前端**: 添加“快速匹配”按钮。
    2.  **房间服务**:
        - 创建一个新的API端点`POST /matchmaking`。
        - 接收到请求后，将一个包含`UserId`的“加入匹配池”消息发布到RabbitMQ的`matchmaking_queue`。
        - 立即向客户端返回`202 Accepted`，表示请求已被接受，正在处理。
    3.  **Matcher Service**:
        - 一个独立的后台工作服务（Worker Service），持续监听`matchmaking_queue`。
        - 在内存中维护一个等待匹配的玩家列表。
        - 当池中有两个或更多玩家时，将他们配对，创建一个新房间，然后通过SignalR直接通知这两位玩家游戏已开始，并提供房间ID。
- **优势**:
    - **用户体验**: 用户无需等待，可以立即得到响应。
    - **系统弹性**: 即使撮合服务暂时不可用，匹配请求也不会丢失，而是暂存在队列中。

---

## 4. 阶段验收标准

当以下所有条件均满足时，第五阶段开发工作视为完成：

1.  **[✅] 高级AI上线**: 用户可以在游戏中选择与“困难”等级的AI对战，该AI表现出明显优于基础版本的策略性。
2.  **[✅] 智能告警生效**: 成功触发并收到一个由异常检测（而非固定阈值）生成的告警。
3.  **[✅] 业务洞察**: Power BI（或同类工具）中的仪表盘能够正确展示用户行为数据，并且可以基于这些数据得出一个有意义的业务洞察（例如，“70%的玩家在游戏的前三步都下在天元附近”）。
4.  **[✅] 异步匹配可用**: 用户可以通过“快速匹配”功能成功地与其他玩家开始一局游戏，并且在等待期间UI没有被阻塞。
5.  **[✅] 统一监控视图**: Grafana的统一业务健康仪表盘已建立，能够同时展示来自不同数据源的业务和系统指标。
6.  **[✅] (可选) 全球化概念验证**: 能够证明应用已成功部署到第二个地理区域，并且可以通过流量管理器将用户路由到延迟最低的区域。